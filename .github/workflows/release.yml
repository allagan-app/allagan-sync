name: Build and Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 9.0.x

      - name: Download Dalamud
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri https://goatcorp.github.io/dalamud-distrib/latest.zip -OutFile latest.zip
          Expand-Archive -Force latest.zip "$env:AppData\XIVLauncher\addon\Hooks\dev"

      - name: Build
        shell: pwsh
        run: dotnet build AllaganSync.slnx --configuration Release

      - name: Prepare release assets
        id: assets
        shell: pwsh
        run: |
          $zip = Get-ChildItem -Path "AllaganSync/bin" -Recurse -Filter "latest.zip" | Select-Object -First 1
          if (-not $zip) {
            throw "latest.zip not found under AllaganSync/bin"
          }

          $icon = Resolve-Path "assets/icon.png"
          if (-not $icon) {
            throw "assets/icon.png not found"
          }

          [xml]$csproj = Get-Content "AllaganSync/AllaganSync.csproj"
          $version = $csproj.Project.PropertyGroup.Version
          if ([string]::IsNullOrWhiteSpace($version)) {
            throw "Version not found in AllaganSync.csproj"
          }

          "zip_path=$($zip.FullName)" >> $env:GITHUB_OUTPUT
          "icon_path=$($icon.Path)" >> $env:GITHUB_OUTPUT
          "version=$version" >> $env:GITHUB_OUTPUT

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            ${{ steps.assets.outputs.zip_path }}
            ${{ steps.assets.outputs.icon_path }}
